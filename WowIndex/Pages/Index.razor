@page "/"
@using WowIndex.Models.RaidingLeaderboards
@using Microsoft.Extensions.Configuration

<MudTable ServerData="@(new Func<TableState, Task<TableData<LeaderboardEntry>>>(ServerReload))" RowsPerPage="20" Dense="true" FixedHeader="true" @ref="table" Hover="true">
    <HeaderContent>
        <MudTh></MudTh>
        <MudTh>Guild</MudTh>
        <MudTh>Realm</MudTh>
        <MudTh>Progress</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Rank">
            @if (context.Rank <= 3)
            {
                <MudText Color="@Color.Primary">@context.Rank</MudText>
            }
            else if (context.Rank <= 10)
            {
                <MudText Style="color: blueviolet">@context.Rank</MudText>
            }
            else
            {
                <MudText Color="Color.Info">@context.Rank</MudText>
            }
        </MudTd>
        <MudTd DataLabel="Guild">
            @{ var link = $"/guild/{context.Region.ToLower()}/{context.RealmSlug}/{context.GuildSlug}/"; }
            <MudButton Link="@link" Color="Color.Info">
                @context.GuildName
            </MudButton>
        </MudTd>
        <MudTd DataLabel="Guild">
            @context.Realm
        </MudTd>
        <MudTd DataLabel="Guild">
            <MudChip Label="true" Size="Size.Small" Variant="Variant.Outlined">@context.Progression / 10</MudChip>
            <MudText Typo="Typo.caption">
                @context.LatestProgressionTime
            </MudText>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager DisableRowsPerPage="true" />
    </PagerContent>
</MudTable>

@code {
    public MudTable<LeaderboardEntry> table;

    private async Task<TableData<LeaderboardEntry>> ServerReload(TableState state)
    {
        var rows = await _context.RankedCastleNathriaLeaderboard.ToListAsync();
        _context.RankedCastleNathriaLeaderboard.RemoveRange(rows);
        await _context.SaveChangesAsync();

        // bind records from database

        var leaderboard = await _context.KillTimeCastleNathria.ToListAsync();
        List<KillTimeCastleNathria> results = new List<KillTimeCastleNathria>();

        results.AddRange(leaderboard.Where(x => x.Progress == 10).OrderBy(x => x.Boss10KillTime));
        results.AddRange(leaderboard.Where(x => x.Progress == 9).OrderBy(x => x.Boss9KillTime));
        results.AddRange(leaderboard.Where(x => x.Progress == 8).OrderBy(x => x.Boss8KillTime));
        results.AddRange(leaderboard.Where(x => x.Progress == 7).OrderBy(x => x.Boss7KillTime));
        results.AddRange(leaderboard.Where(x => x.Progress == 6).OrderBy(x => x.Boss6KillTime));
        results.AddRange(leaderboard.Where(x => x.Progress == 5).OrderBy(x => x.Boss5KillTime));
        results.AddRange(leaderboard.Where(x => x.Progress == 4).OrderBy(x => x.Boss4KillTime));
        results.AddRange(leaderboard.Where(x => x.Progress == 3).OrderBy(x => x.Boss3KillTime));
        results.AddRange(leaderboard.Where(x => x.Progress == 2).OrderBy(x => x.Boss2KillTime));
        results.AddRange(leaderboard.Where(x => x.Progress == 1).OrderBy(x => x.Boss1KillTime));

        List<LeaderboardEntry> leaderboardEntries = new List<LeaderboardEntry>();
        int i = 1;
        var guilds = _context.Guilds.ToList();
        foreach (var item in results)
        {
            var guild = guilds.Where(x => x.Id == item.GuildId).FirstOrDefault();
            DateTime killTime = new DateTime();
            DateTime[] bossTimes = Helpers.CastleNathriaKillTime.GetKillTimes(item);
            foreach (var time in bossTimes)
            {
                if (time != new DateTime())
                {
                    killTime = time;
                    break;
                }
            }

            LeaderboardEntry entry = new LeaderboardEntry
            {
                Rank = i,
                LatestProgressionTime = killTime,
                GuildName = guild.Name,
                Faction = guild.FactionName,
                Realm = guild.Realm,
                Region = guild.Region,
                Progression = item.Progress,
                GuildSlug = guild.NameSlug,
                RealmSlug = guild.RealmSlug
            };

            leaderboardEntries.Add(entry);
            _context.RankedCastleNathriaLeaderboard.Add(entry);
            i++;
        }
        await _context.SaveChangesAsync();

        StateHasChanged();
        return new TableData<LeaderboardEntry>() { Items = leaderboardEntries };
    }
}
