@page "/"

@if (records == null)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}

@if (records != null)
{
    <MudContainer>
        <MudTable RowsPerPage="100" Dense="true" Height="calc(100vh - 116px)" FixedHeader="true" Items="@records" Hover="true">
            <!--<ToolBarContent>
                <MudText Typo="Typo.h6">Top 200 guilds</MudText>
                <MudToolBarSpacer />-->
            @*<MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>*@
            <!--</ToolBarContent>-->
            <HeaderContent>
                <MudTh></MudTh>
                <MudTh>Guild</MudTh>
                <MudTh>Region</MudTh>
                <MudTh>Realm</MudTh>
                <MudTh></MudTh>
                <MudTh>Progress</MudTh>
            </HeaderContent>
            <RowTemplate>
                @if (context.faction == "ALLIANCE")
                    {
                    <MudTd Class="ally-blue" DataLabel="Rank"><b>@context.rank</b></MudTd>
                    <MudTd Class="ally-blue" DataLabel="Guild">@context.name</MudTd>
                    <MudTd Class="ally-blue" DataLabel="Region">@context.region</MudTd>
                    <MudTd Class="ally-blue" DataLabel="Realm">@context.realm</MudTd>
                    <MudTd Class="ally-blue" DataLabel="Progress">
                        <MudAvatar Image="img/alliance.png" Size="Size.Small" Class="ma-2" />
                    </MudTd>
                    <MudTd Class="ally-blue" DataLabel="Progress"></MudTd>
                    }
                    else
                    {
                    <MudTd Class="horde-red" DataLabel="Rank"><b>@context.rank</b></MudTd>
                    <MudTd Class="horde-red" DataLabel="Guild">@context.name</MudTd>
                    <MudTd Class="horde-red" DataLabel="Region">@context.region</MudTd>
                    <MudTd Class="horde-red" DataLabel="Realm">@context.realm</MudTd>
                    <MudTd Class="horde-red" DataLabel="Progress">
                        <MudAvatar Image="img/horde.png" Size="Size.Small" Class="ma-2" />
                    </MudTd>
                    <MudTd Class="horde-red" DataLabel="Progress"></MudTd>
                    }
            </RowTemplate>
            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    </MudContainer>
}
@code {
    public List<GuildRecord> records { get; set; }

    private string searchString = "";

    public HttpClient apiConnection()
    {
        var APIclient = new HttpClient();
        APIclient.BaseAddress = new Uri("https://us.api.blizzard.com/");

        return APIclient;
    }

    protected override async Task OnInitializedAsync()
    {
        // bind records from database
        records = await _context.Records.OrderBy(x => x.timestamp).ToListAsync();

        // if record is older than 1 min then all a new record from the api and update the database
        if (records.Count == 0 || records[0].age < DateTime.Now.AddSeconds(-30))
        {
            // Call Blizzard API
            var apiResponseAlliance = await apiConnection().GetAsync("data/wow/leaderboard/hall-of-fame/castle-nathria/alliance?namespace=dynamic-us&locale=en_US&access_token=USOnT59Qy4a16BgShX3ktbzt0SeqzoljP2");
            var apiResponseHorde = await apiConnection().GetAsync("data/wow/leaderboard/hall-of-fame/castle-nathria/horde?namespace=dynamic-us&locale=en_US&access_token=USOnT59Qy4a16BgShX3ktbzt0SeqzoljP2");
            if (apiResponseHorde.IsSuccessStatusCode && apiResponseAlliance.IsSuccessStatusCode)
            {
                // get json strings
                var resultHorde = apiResponseHorde.Content.ReadAsStringAsync().Result;
                var resultAlliance = apiResponseAlliance.Content.ReadAsStringAsync().Result;

                // Convert to data arrays
                var GuildRankingsListHorde = JsonConvert.DeserializeObject<LeaderboardEntries>(resultHorde);
                var GuildRankingsListAlliance = JsonConvert.DeserializeObject<LeaderboardEntries>(resultAlliance);

                // combine the two data arrays
                var guildRankingsArray = new GuildRanking[GuildRankingsListAlliance.entries.Length + GuildRankingsListHorde.entries.Length];
                int j = 0;
                for (int i = 0; i < guildRankingsArray.Length; i++)
                {
                    if (i < 100)
                        guildRankingsArray[i] = GuildRankingsListHorde.entries[i];
                    else
                    {
                        guildRankingsArray[i] = GuildRankingsListAlliance.entries[j];
                        j++;
                    }
                }

                // reset the database table
                await _context.Database.ExecuteSqlRawAsync("TRUNCATE TABLE Records");
                await _context.SaveChangesAsync();

                foreach (var guild in guildRankingsArray.ToList())
                {
                    await _context.Records.AddAsync(new GuildRecord()
                    {
                        rank = guild.rank,
                        region = guild.region,
                        name = guild.guild.name,
                        faction = guild.faction.type,
                        age = DateTime.Now,
                        timestamp = guild.timestamp
                    });
                }

                await _context.SaveChangesAsync();
                records = await _context.Records.OrderBy(x => x.timestamp).ToListAsync();
                StateHasChanged();
            }
        }
    }
}
