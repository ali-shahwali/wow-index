@page "/"
@using WowIndex.Models.RaidingLeaderboards
@using Microsoft.Extensions.Configuration

<MudGrid>
    <MudItem xs="12">
        <MudCard Class="index-banner">
            <MudCardContent>
                <MudText Style="color: white" Typo="Typo.h6">Castle Nathria</MudText>
                @if (Diagnostics != null)
                {
                    <MudText Style="color: cornflowerblue" Typo="Typo.body1">There are currently @Diagnostics.GuildsWithFullClear guilds with full clears on record</MudText>
                    <MudText Style="color: cornflowerblue" Typo="Typo.body1">
                        It takes on average @Diagnostics.AverageProgressionTime days of progression for a full clear
                        and the most difficult boss appears to be @Diagnostics.MostDifficultBoss .
                    </MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="8">
        <MudText Class="mb-2" Typo="Typo.h6">Mythic World Leaderboard</MudText>
        <MudTable Outlined="true" Items="LeaderboardEntries" RowsPerPage="20" Dense="true" FixedHeader="true" @ref="Table" Hover="true">
            <HeaderContent>
                <MudTh></MudTh>
                <MudTh>Guild</MudTh>
                <MudTh>Realm</MudTh>
                <MudTh>Progress</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Rank">
                    @if (context.RankWorld <= 3)
                    {
                        <MudText Color="@Color.Primary">@context.RankWorld</MudText>
                    }
                    else if (context.RankWorld <= 10)
                    {
                        <MudText Style="color: blueviolet">@context.RankWorld</MudText>
                    }
                    else
                    {
                        <MudText Color="Color.Info">@context.RankWorld</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Guild">
                    @{ var link = $"/guild/{context.Region.ToLower()}/{context.RealmSlug}/{context.GuildSlug}/"; }
                    @if (context.Faction == "Horde")
                    {
                        <MudButton Class="table-btn" Link="@link" Color="Color.Error">
                            @context.GuildName
                        </MudButton>
                    }
                    else
                    {
                        <MudButton Class="table-btn" Link="@link" Color="Color.Info">
                            @context.GuildName
                        </MudButton>
                    }
                </MudTd>
                <MudTd DataLabel="Guild">
                    @context.Realm
                </MudTd>
                <MudTd DataLabel="Guild">
                    @if (context.Progression == 10)
                    {
                        <MudChip Label="true" Color="Color.Primary" Size="Size.Small" Variant="Variant.Outlined">@context.Progression / 10</MudChip>
                    }
                    else
                    {
                        <MudChip Label="true" Color="Color.Info" Size="Size.Small" Variant="Variant.Outlined">@context.Progression / 10</MudChip>
                    }
                    <MudText Typo="Typo.caption">
                        @context.LatestProgressionTime.ToShortDateString()
                    </MudText>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager DisableRowsPerPage="true" />
            </PagerContent>
        </MudTable>
    </MudItem>
    <MudItem xs="4">
        <MudText Class="mb-2" Typo="Typo.h6">Recent Activity</MudText>
        @foreach (var item in RecentClears)
        {
            <MudCard Class="mb-2" Outlined="true">
                <MudCardContent>
                    @{
                        TimeSpan time = DateTime.Now - item.LatestProgressionTime;
                        string link = $"/guild/{item.Region}/{item.RealmSlug}/{item.GuildSlug}/";
                    }
                    <MudText>Congrats to <a href="@link" style="color: darkmagenta">@item.GuildName</a> for clearing castle nathria</MudText>

                    <MudText Typo="Typo.body2">They cleared it @time.Days days and @time.Hours hours ago</MudText>
                </MudCardContent>
            </MudCard>
        }
    </MudItem>
</MudGrid>

@code {
    // Properties
    public MudTable<LeaderboardEntry> Table;
    public List<LeaderboardEntry> LeaderboardEntries { get; set; }
    public List<LeaderboardEntry> RecentClears { get; set; }
    public List<Models.GuildObjects.Guild> Guilds { get; set; }
    public Data.SiteDiagnostic Diagnostics { get; set; }

    // Page load
    protected override async Task OnInitializedAsync()
    {
        // get lists
        LeaderboardEntries = _context.RankedCastleNathriaLeaderboard.ToList();
        RecentClears = _context.RankedCastleNathriaLeaderboard.Where(x => x.Progression == 10).OrderByDescending(x => x.LatestProgressionTime).Take(5).ToList();
        Guilds = _context.Guilds.ToList();
        Diagnostics = _context.SiteDiagnostics.OrderBy(x => x.CreationTime).LastOrDefault();

        if (LeaderboardEntries.Count == 0 || (LeaderboardEntries.FirstOrDefault().ExpirationTime < DateTime.Now))
        {
            // delete outdated records
            if (LeaderboardEntries.Count > 0)
            {
                _context.RankedCastleNathriaLeaderboard.RemoveRange(LeaderboardEntries);
                await _context.SaveChangesAsync();
            }

            // build up a sorted leaderboard
            var Leaderboard = await _context.KillTimeCastleNathria.ToListAsync();
            var LeaderboardSorted = new List<KillTimeCastleNathria>();

            LeaderboardSorted.AddRange(Leaderboard.Where(x => x.Progress == 10).OrderBy(x => x.Boss10KillTime));
            LeaderboardSorted.AddRange(Leaderboard.Where(x => x.Progress == 9).OrderBy(x => x.Boss9KillTime));
            LeaderboardSorted.AddRange(Leaderboard.Where(x => x.Progress == 8).OrderBy(x => x.Boss8KillTime));
            LeaderboardSorted.AddRange(Leaderboard.Where(x => x.Progress == 7).OrderBy(x => x.Boss7KillTime));
            LeaderboardSorted.AddRange(Leaderboard.Where(x => x.Progress == 6).OrderBy(x => x.Boss6KillTime));
            LeaderboardSorted.AddRange(Leaderboard.Where(x => x.Progress == 5).OrderBy(x => x.Boss5KillTime));
            LeaderboardSorted.AddRange(Leaderboard.Where(x => x.Progress == 4).OrderBy(x => x.Boss4KillTime));
            LeaderboardSorted.AddRange(Leaderboard.Where(x => x.Progress == 3).OrderBy(x => x.Boss3KillTime));
            LeaderboardSorted.AddRange(Leaderboard.Where(x => x.Progress == 2).OrderBy(x => x.Boss2KillTime));
            LeaderboardSorted.AddRange(Leaderboard.Where(x => x.Progress == 1).OrderBy(x => x.Boss1KillTime));

            int rankWorld = 1;
            foreach (var item in LeaderboardSorted)
            {
                var guild = Guilds.Where(x => x.Id == item.GuildId).FirstOrDefault();
                DateTime killTime = new DateTime();
                DateTime[] bossTimes = Helpers.CastleNathriaKillTimeHelper.GetKillTimes(item);
                foreach (var time in bossTimes)
                {
                    if (time != new DateTime())
                    {
                        killTime = time;
                        break;
                    }
                }

                // build entry to display in list on page
                LeaderboardEntry entry = new LeaderboardEntry
                {
                    RankWorld = rankWorld,
                    RankRealm = 0,
                    LatestProgressionTime = killTime,
                    GuildName = guild.Name,
                    Faction = guild.FactionName,
                    Realm = guild.Realm,
                    Region = guild.Region,
                    Progression = item.Progress,
                    GuildSlug = guild.NameSlug,
                    RealmSlug = guild.RealmSlug
                };

                LeaderboardEntries.Add(entry);

                // add this new soted list to the db
                _context.RankedCastleNathriaLeaderboard.Add(entry);
                rankWorld++;
            }

            await _context.SaveChangesAsync();
        }

        LeaderboardEntries = LeaderboardEntries.OrderBy(x => x.RankWorld).ToList();
    }
}
