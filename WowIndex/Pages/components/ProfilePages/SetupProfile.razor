@page "/setupProfile"
@using System.Net

<MudContainer Class="mt-16" MaxWidth="MaxWidth.Medium">
    <EditForm Model="@region" OnValidSubmit="OnValidSubmit">
        <DataAnnotationsValidator />
        <MudGrid Spacing="6" Class="mt-16">
            <MudItem xs="7">
                <MudText Typo="Typo.h5" GutterBottom="true">Connect to Battle.net</MudText>
                <MudGrid>
                    <MudItem xs="12">
                        <MudSelect Required="true" T="string" @bind-Value="region" Label="Region">
                            <MudSelectItem Value="@("eu")">Europe</MudSelectItem>
                            <MudSelectItem Value="@("us")">North America</MudSelectItem>
                            <MudSelectItem Value="@("kr")">Korea/우리 나라</MudSelectItem>
                            <MudSelectItem Value="@("cn")">China/中國/中国</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem Class="d-flex justify-end" xs="6">
                        @{ 
                            var flag = "";
                        }
                        <MudButton Disabled="region.Equals(flag)" ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Connect</MudButton>
                    </MudItem>
                </MudGrid>
            </MudItem>
        </MudGrid>
    </EditForm>
</MudContainer>

@code {
    // TODO:
    // To keep the number of requests down we should do the same as with the leaderboard and store the data in the database and
    // and only grab now api data if it's older than 15mins or so.

    // TODO:
    // Requests need to be dynamic and suppost all regions and not just assume eu.

    [Parameter]
    public string region { get; set; }= "";

    protected override async Task OnInitializedAsync()
    {
        var AuthState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (!AuthState.User.Identity.IsAuthenticated)
        {
            Snackbar.Add("You must log in first!", Severity.Normal);
            NavigationManager.NavigateTo("/");
        }

        var checkProfile = _context.Profiles.Where(x => x.AspEmail == AuthState.User.Identity.Name).FirstOrDefault();
        if(checkProfile != null)
        {
            Snackbar.Add("You have already setup your profile!", Severity.Normal);
            NavigationManager.NavigateTo("/profile");
        }
    }

    private async Task OnValidSubmit()
    {
        string clientId = Configuration["APIClientID"];
        string str = NavigationManager.Uri.Split('/')[3];
        if (str.Equals("setupProfile"))
        {
            // build request
            var client = new HttpClient();
            client.BaseAddress = new Uri($"https://{region}.battle.net/oauth/authorize");
            string responseType = "code";
            
            string redirectURI = $"{WebUtility.UrlEncode(NavigationManager.BaseUri)}authorize%2F{region}";
            string scope = "wow.profile";

            // send request
            var auth = await client.GetAsync($"?response_type={responseType}&client_id={clientId}&redirect_uri={redirectURI}&scope={scope}");

            // navigate to ruturn url
            NavigationManager.NavigateTo(auth.RequestMessage.RequestUri.OriginalString);
        }
    }
}
