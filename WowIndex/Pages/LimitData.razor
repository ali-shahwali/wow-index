@page "/limitData"
@using Newtonsoft.Json.Linq
@using WowIndex.CustomScrapers

<MudContainer>

    <MudText Class="my-6" Typo="Typo.h4">&lt;LIMIT&gt;Maxibabe - Castle Nathria Achievements</MudText>
    <MudGrid Class="mt-8">
        @foreach (var item in model)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@item.Name</MudText>
                        </CardHeaderContent>
                        @*<CardHeaderActions>
                                <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Default" />
                            </CardHeaderActions>*@
                    </MudCardHeader>
                    <MudCardContent>
                        @if (item.Time.ToString() != "1/1/0001 12:00:00 AM")
                        {
                            <MudChip Size="Size.Small" Icon="@Icons.Material.Outlined.CheckCircleOutline" Color="Color.Success">Completed</MudChip>
                        }
                        else
                        {
                            <MudChip Size="Size.Small" Icon="@Icons.Material.Outlined.HighlightOff" Color="Color.Error">Incomplete</MudChip>
                        }
                        <MudText Class="mt-5" Typo="Typo.body2">@item.Description</MudText>
                    </MudCardContent>
                    <MudCardActions>
                        @if (item.Time.ToString() != "1/1/0001 12:00:00 AM")
                        {
                            <MudButton Variant="Variant.Text" Color="Color.Primary">@item.Time.ToString()</MudButton>
                        }
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>
</MudContainer>


@code {
    List<WowIndex.Models.RaidAchievement> model = new List<WowIndex.Models.RaidAchievement>();

    public string FullPage { get; set; }

    public List<string> items = new List<string>();

    protected override async Task OnInitializedAsync()
    {
        var region = "us";
        var realm = "illidan";
        var guildSlug = "complexity-limit";

        HttpClient client = new HttpClient();
        client.BaseAddress = new Uri($"https://{region}.api.blizzard.com/");

        var accessToken = await Helpers.AuthTokenHelper.ValidateToken(_context);

        var response = await client.GetAsync($"data/wow/guild/{realm}/{guildSlug}/roster?namespace=profile-{region}&locale=en_US&access_token={accessToken.token}");

        string rosterString = await response.Content.ReadAsStringAsync();

        var roster = JsonConvert.DeserializeObject<Models.POCO.GuildRosterPOCO>(rosterString);
        var rosterMembers = roster.members;

        var progressCounts = new List<int>();

        foreach (var item in rosterMembers)
        {
            if(item.character.level == 60)
            {
                var completedAchievements = CustomScrapers.ScrapePlayerShadowlandsRaidAchievements(region, realm, item.character.name).Result;
                progressCounts.Add(completedAchievements.Count());
            }
        }

        StateHasChanged();
    }
}
